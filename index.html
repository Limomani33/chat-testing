<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SoapyChat</title>

<style id="soapy-style">
:root {
  --main-color: #a855f7;
  --bg-gradient: radial-gradient(circle at top, #ff5ad6, #502070, #0b0314);
}

html, body {
  margin: 0;
  height: 100%;
  font-family: system-ui, sans-serif;
  background: var(--bg-gradient);
  color: white;
  overflow: hidden;
}

#app {
  display: flex;
  flex-direction: column;
  height: 100%;
}

#chat {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
}

.msg {
  margin-bottom: 8px;
  background: rgba(255,255,255,0.08);
  padding: 8px 12px;
  border-radius: 12px;
  max-width: 70%;
}

.me {
  margin-left: auto;
  background: var(--main-color);
}

#inputBar {
  display: flex;
  padding: 12px;
  gap: 8px;
  backdrop-filter: blur(10px);
}

input {
  flex: 1;
  border-radius: 999px;
  border: none;
  padding: 10px 14px;
  outline: none;
}

button {
  border: none;
  border-radius: 999px;
  padding: 10px 14px;
  background: var(--main-color);
  color: white;
  font-size: 16px;
  cursor: pointer;
}
</style>
</head>

<body>
<div id="app">

  <div id="chat"></div>

  <div id="inputBar">
    <button id="btn1">‚û§</button>
    <button id="btn2">üñºÔ∏è</button>
    <button id="btn3">üéµ</button>
    <input id="msgInput" placeholder="Type something..." />
  </div>

</div>

<script>
const chat = document.getElementById("chat");
const input = document.getElementById("msgInput");

function addMsg(text, me=false) {
  const d = document.createElement("div");
  d.className = "msg" + (me ? " me" : "");
  d.textContent = text;
  chat.appendChild(d);
  chat.scrollTop = chat.scrollHeight;
}

// ============================
// SCPACK LOADER
// ============================
document.body.addEventListener("dragover", e => e.preventDefault());
document.body.addEventListener("drop", e => {
  e.preventDefault();
  const file = e.dataTransfer.files[0];
  if (!file || !file.name.endsWith(".scpack")) return;
  loadSCPACK(file);
});

function loadSCPACK(file) {
  const reader = new FileReader();
  reader.onload = () => parseSCPACK(reader.result);
  reader.readAsArrayBuffer(file);
}

function parseSCPACK(buf) {
  const dv = new DataView(buf);
  let i = 0;

  function readStr() {
    const len = dv.getUint8(i++);
    let s = "";
    for (let j = 0; j < len; j++) {
      s += String.fromCharCode(dv.getUint8(i++));
    }
    return decodeURIComponent(escape(s));
  }

  // Header
  const magic = String.fromCharCode(...new Uint8Array(buf.slice(0,8)));
  i = 9;
  if (!magic.startsWith("SCPACK")) return alert("Invalid SCPACK");

  // Gradients
  const gCount = dv.getUint8(i++);
  const gradients = [];
  for (let g = 0; g < gCount; g++) gradients.push(readStr());

  // Emojis
  const eCount = dv.getUint8(i++);
  const emojis = [];
  for (let e = 0; e < eCount; e++) emojis.push(readStr());

  // Color
  const color = readStr();

  // Buttons
  const bCount = dv.getUint8(i++);
  const buttons = [];
  for (let b = 0; b < bCount; b++) {
    buttons.push({
      label: readStr(),
      action: dv.getUint8(i++)
    });
  }

  applyTheme(gradients, emojis, color, buttons);
}

function applyTheme(gradients, emojis, color, buttons) {
  document.documentElement.style.setProperty("--bg-gradient", gradients[0]);
  document.documentElement.style.setProperty("--main-color", color);

  // Apply emojis
  const btnEls = [
    document.getElementById("btn1"),
    document.getElementById("btn2"),
    document.getElementById("btn3")
  ];

  emojis.forEach((e, idx) => {
    if (btnEls[idx]) btnEls[idx].textContent = e;
  });

  // Wire buttons
  btnEls.forEach(b => b.onclick = null);

  buttons.forEach((b, idx) => {
    const el = btnEls[idx];
    if (!el) return;
    el.textContent = b.label;

    if (b.action === 1) {
      el.onclick = sendMsg;
    } else if (b.action === 2) {
      el.onclick = () => addMsg("üñºÔ∏è Image action triggered");
    } else if (b.action === 3) {
      el.onclick = () => addMsg("üéµ SoapySound triggered");
    }
  });

  addMsg("ü´ß SCPACK Applied!");
}

// ============================
// ACTIONS
// ============================
function sendMsg() {
  if (!input.value) return;
  addMsg(input.value, true);
  input.value = "";
}

document.getElementById("btn1").onclick = sendMsg;
</script>
</body>
</html>
