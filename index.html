<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Soapy Chat</title>
<style>
html,body{height:100%;margin:0;font-family:system-ui;background:radial-gradient(circle at top,#ff5ad6,#502070,#0b0314);color:white;}
#app{width:720px;height:85%;margin:40px auto;background:rgba(8,8,20,.92);border-radius:14px;display:flex;flex-direction:column;box-shadow:0 0 50px #ff5ad688;}
#chat{flex:1;padding:12px;overflow-y:auto;}
.msg{margin-bottom:10px;}
.name{color:#ff90ff;font-weight:bold;}
img{max-width:280px;border-radius:10px;margin-top:6px;box-shadow:0 0 15px #ff5ad655;}
audio{width:240px;}
.audio-bubble{margin-top:6px;padding:8px;border-radius:14px;background:#1a0f2a;box-shadow:inset 0 0 10px #000;}
.audio-bubble.voice{background:linear-gradient(135deg,#ff5ad6,#7a3cff);}
#controls{display:flex;gap:6px;padding:10px;align-items:center;}
#preview{padding:6px 10px;font-size:13px;color:#ffd1ff;}
#timer{font-size:13px;color:#ffd1ff;}
input,button{background:#1a0f2a;border:1px solid #ff5ad688;color:white;padding:8px;border-radius:8px;}
button{background:linear-gradient(135deg,#ff5ad6,#7a3cff);box-shadow:0 0 12px #ff5ad666;cursor:pointer;}
button.icon{width:40px;height:40px;padding:0;font-size:18px;}
</style>
</head>
<body>
<div id="app">
  <div id="chat"></div>
  <div id="preview"></div>
  <div id="controls">
    <button class="icon" onclick="pickImage()">üñºÔ∏è</button>
    <button class="icon" onclick="pickAudio()">üîä</button>
    <button class="icon" id="voiceBtn" onclick="toggleVoice()">üé§</button>
    <span id="timer"></span>
    <input id="name" placeholder="Name">
    <input id="text" placeholder="Message">
    <input type="file" id="img" accept="image/*" hidden>
    <input type="file" id="aud" accept="audio/*" hidden>
    <button onclick="send()">Send</button>
  </div>
</div>

<script>
const chat=document.getElementById("chat");
const preview=document.getElementById("preview");
const timer=document.getElementById("timer");
const nameInput=document.getElementById("name");
const textInput=document.getElementById("text");
const imgInput=document.getElementById("img");
const audInput=document.getElementById("aud");
const voiceBtn=document.getElementById("voiceBtn");

let ws;
let joined=false;
let userName="";
let pendingFile=null;
let pendingType=null;
let pendingVoice=false;

let recording=false,seconds=0,timerInt,recorder=null;

// --- Initialize WebSocket ---
function initWS(){
  ws=new WebSocket(`${location.protocol==='https:'?'wss':'ws'}://${location.host}/ws`);
  ws.onmessage=e=>{
    const msg=JSON.parse(e.data);
    if(msg.type==="history") msg.messages.forEach(addMessage);
    else addMessage(msg);
  };
  ws.onopen=()=>{console.log("WebSocket connected");};
}
initWS();

function addMessage(msg){
  const d=document.createElement("div"); d.className="msg";
  if(msg.type==="image") d.innerHTML=`<span class="name">${msg.name}:</span><br><img src="${msg.content}">`;
  else if(msg.type==="audio") d.innerHTML=`<span class="name">${msg.name}:</span><div class="audio-bubble ${msg.voice?"voice":""}"><audio controls src="${msg.content}"></audio></div>`;
  else d.innerHTML=`<span class="name">${msg.name}:</span> ${msg.content}`;
  chat.appendChild(d); chat.scrollTop=chat.scrollHeight;
}

// ===== SEND =====
function send(){
  if(!ws || ws.readyState!==WebSocket.OPEN) return alert("WebSocket not connected yet!");

  if(!joined){
    userName=nameInput.value||"Anonymous";
    ws.send(JSON.stringify({type:"join", name:userName}));
    nameInput.disabled=true;
    joined=true;
  }

  // Send file if pending
  if(pendingFile){
    // If Blob (voice), convert to base64 first
    if(pendingFile instanceof Blob){
      const reader=new FileReader();
      reader.onload=()=>{
        ws.send(JSON.stringify({type:pendingType, content:reader.result, voice:pendingVoice}));
        pendingFile=null; pendingType=null; pendingVoice=false;
        preview.textContent="";
      };
      reader.readAsDataURL(pendingFile);
    } else {
      // already base64
      ws.send(JSON.stringify({type:pendingType, content:pendingFile, voice:pendingVoice}));
      pendingFile=null; pendingType=null; pendingVoice=false;
      preview.textContent="";
    }
    return;
  }

  // Send text
  if(textInput.value.trim()){
    ws.send(JSON.stringify({type:"message", content:textInput.value}));
    textInput.value="";
  }
}

// ===== FILE PICKERS =====
imgInput.onchange=()=>{
  const file=imgInput.files[0];
  const reader=new FileReader();
  reader.onload=()=>{pendingFile=reader.result; pendingType="image"; pendingVoice=false; preview.textContent="üñºÔ∏è Image ready to send";};
  reader.readAsDataURL(file);
};
audInput.onchange=()=>{
  const file=audInput.files[0];
  const reader=new FileReader();
  reader.onload=()=>{pendingFile=reader.result; pendingType="audio"; pendingVoice=false; preview.textContent="üîä Audio ready to send";};
  reader.readAsDataURL(file);
};
function pickImage(){imgInput.click();}
function pickAudio(){audInput.click();}

// ===== VOICE RECORDING =====
async function toggleVoice(){
  if(!recording){
    recording=true; seconds=0; voiceBtn.textContent="‚¨ÜÔ∏è"; timer.textContent="0:00 / 1:00";
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    recorder=new MediaRecorder(stream); const chunks=[];
    recorder.ondataavailable=e=>chunks.push(e.data);
    recorder.onstop=()=>{
      const blob=new Blob(chunks,{type:"audio/webm"});
      const reader=new FileReader();
      reader.onload=()=>{
        pendingFile=reader.result; pendingType="audio"; pendingVoice=true;
        preview.textContent="üé§ Voice ready to send"; 
        voiceBtn.textContent="üé§"; timer.textContent=""; recording=false;
      };
      reader.readAsDataURL(blob);
      stream.getTracks().forEach(t=>t.stop());
      clearInterval(timerInt);
    };
    recorder.start();
    timerInt=setInterval(()=>{
      seconds++;
      timer.textContent=`0:${String(seconds).padStart(2,"0")} / 1:00`;
      if(seconds>=60) recorder.stop();
    },1000);
  } else {
    recorder.stop();
  }
}
</script>
</body>
</html>
