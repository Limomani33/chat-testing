<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Soapysounds</title>

<style>
html, body {
  margin: 0;
  height: 100%;
  font-family: system-ui;
  background: radial-gradient(circle at center, #ff5ad6, #3a1c5a, #05010a);
  color: white;
  user-select: none;
}

#window {
  width: 420px;
  height: 360px;
  margin: auto;
  margin-top: 60px;
  background: rgba(12,12,30,0.95);
  border-radius: 16px;
  box-shadow: 0 0 40px #ff5ad688;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

#titlebar {
  padding: 10px 14px;
  font-weight: bold;
  background: rgba(0,0,0,0.35);
}

#content {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

#audio {
  width: 90%;
  margin-bottom: 16px;
}

#controls {
  display: flex;
  gap: 10px;
  padding: 12px;
}

button {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 8px;
  background: linear-gradient(135deg, #ff5ad6, #9b5cff);
  color: white;
  font-size: 14px;
  cursor: pointer;
}

button:hover {
  filter: brightness(1.15);
}

#drop {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  background: rgba(0,0,0,0.7);
  z-index: 999;
}
</style>
</head>

<body>

<div id="window">
  <div id="titlebar">ðŸ«§ Soapysounds</div>

  <div id="content">
    <audio id="audio" controls></audio>
  </div>

  <div id="controls">
    <!-- SCPACK buttons injected here -->
  </div>
</div>

<div id="drop">Drop SCPACK</div>

<script>
/* ======================
   BASIC AUDIO + SOCKET
====================== */

const audio = document.getElementById("audio");
let ws = null;

// Optional websocket hookup
// ws = new WebSocket("wss://soapychat.onrender.com/ws");

/* ======================
   SCPACK LOADER
====================== */

const drop = document.getElementById("drop");

document.addEventListener("dragover", e => {
  e.preventDefault();
  drop.style.display = "flex";
});

document.addEventListener("dragleave", () => {
  drop.style.display = "none";
});

document.addEventListener("drop", async e => {
  e.preventDefault();
  drop.style.display = "none";

  const file = e.dataTransfer.files[0];
  if (!file || !file.name.endsWith(".scpack")) return;

  const buf = await file.arrayBuffer();
  const view = new DataView(buf);
  let offset = 0;

  function readString() {
    const len = view.getUint8(offset++);
    const str = new TextDecoder().decode(buf.slice(offset, offset + len));
    offset += len;
    return str;
  }

  const magic = new TextDecoder().decode(buf.slice(0, 8));
  if (magic !== "SCPACKSS") {
    alert("Invalid Soapysounds SCPACK");
    return;
  }

  offset = 9; // magic + version

  /* ===== STYLE ===== */

  document.body.style.background = readString();
  document.getElementById("window").style.background = readString();
  const btnColor = readString();
  document.body.style.color = readString();

  /* ===== EMOJIS ===== */

  const emojiCount = view.getUint8(offset++);
  window.SS_EMOJIS = [];
  for (let i = 0; i < emojiCount; i++) {
    SS_EMOJIS.push(readString());
  }

  /* ===== BUTTONS ===== */

  const controls = document.getElementById("controls");
  controls.innerHTML = "";

  for (let i = 0; i < 3; i++) {
    const label = readString();
    const action = view.getUint8(offset++);

    const b = document.createElement("button");
    b.textContent = label;
    b.style.background = btnColor;
    b.onclick = () => handleAction(action);
    controls.appendChild(b);
  }

  console.log("ðŸ«§ Soapysounds SCPACK applied");
});

/* ======================
   ACTION HANDLER
====================== */

function handleAction(id) {
  // 1 = Play / Pause
  if (id === 1) {
    audio.paused ? audio.play() : audio.pause();
  }

  // 2 = Stop
  if (id === 2) {
    audio.pause();
    audio.currentTime = 0;
  }

  // 3 = Send Audio
  if (id === 3) {
    if (!audio.src) return alert("No audio loaded");
    if (!ws) return alert("WebSocket not connected");

    ws.send(JSON.stringify({
      type: "audio",
      content: audio.src
    }));
  }
}
</script>

</body>
</html>
