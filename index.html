<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Soapy Chat</title>

<style>
html,body{
  height:100%;margin:0;font-family:system-ui;
  background:radial-gradient(circle at top,#ff5ad6,#502070,#0b0314);
  color:white;
}
#app{
  width:720px;height:90vh;margin:20px auto;
  background:rgba(8,8,20,.92);
  border-radius:14px;box-shadow:0 0 50px #ff5ad688;
  padding:10px;display:flex;flex-direction:column;gap:10px;
}
#topbar{font-size:20px;font-weight:bold;}
#chat{
  flex:1;overflow-y:auto;padding:12px;
  background:rgba(0,0,0,.2);border-radius:10px;
}
.msg{margin-bottom:10px}
.name{color:#ff90ff;font-weight:bold}
img{max-width:280px;border-radius:10px;margin-top:6px}
input,button{
  background:#1a0f2a;border:1px solid #ff5ad688;
  color:white;padding:8px;border-radius:8px;
}
button{
  background:linear-gradient(135deg,#ff5ad6,#7a3cff);
  cursor:pointer;
}
button.icon{width:40px;height:40px;padding:0;font-size:18px}

/* ==== SoapySounds Window ==== */
#soundWindow{
  position:absolute;top:120px;left:120px;
  width:300px;background:#0e0620;
  border-radius:10px;box-shadow:0 0 30px #ff5ad699;
  display:none;flex-direction:column;
}
#soundTitle{
  background:#2a1040;
  padding:6px 10px;
  cursor:move;
  display:flex;justify-content:space-between;
  border-radius:10px 10px 0 0;
}
#soundContent{padding:10px}
.close{cursor:pointer;font-weight:bold}
</style>
</head>

<body>
<div id="app">
  <div id="topbar">Connection: ‚úÖ</div>

  <div>
    <button class="icon" onclick="openSoundWindow()">üîä</button>
    <button class="icon" onclick="pickImage()">üñºÔ∏è</button>
    <input id="name" placeholder="Name">
    <input id="text" placeholder="Message">
    <button onclick="send()">Send</button>
    <input id="img" type="file" accept="image/*" hidden>
  </div>

  <div id="chat"></div>
</div>

<!-- SoapySounds -->
<div id="soundWindow">
  <div id="soundTitle">
    <span>SoapySounds</span>
    <span class="close" onclick="closeSoundWindow()">‚úñ</span>
  </div>
  <div id="soundContent">
    <input type="file" id="audioFile" accept="audio/*"><br><br>
    <audio id="audioPlayer" controls style="width:100%"></audio><br><br>
    <button onclick="sendAudio()">Send Audio</button>
  </div>
</div>
<script>
/* ===== ELEMENT REFERENCES ===== */
const chat = document.getElementById("chat");
const connectionEl = document.getElementById("topbar");

const nameInput = document.getElementById("name");
const textInput = document.getElementById("text");
const imgInput = document.getElementById("img");

const soundWindow = document.getElementById("soundWindow");
const soundTitle = document.getElementById("soundTitle");
const audioFile = document.getElementById("audioFile");
const audioPlayer = document.getElementById("audioPlayer");

/* ===== STATE ===== */
let ws;
let joined = false;
let currentAudio = null;

/* ===== CONNECT ===== */
function connect() {
  ws = new WebSocket(
    `${location.protocol === "https:" ? "wss" : "ws"}://${location.host}/ws`
  );

  ws.onopen = () => {
    connectionEl.textContent = "Connection: ‚úÖ";
    connectionEl.style.color = "#00ff88";
  };

  ws.onclose = () => {
    connectionEl.textContent = "Connection: üö´ (Reload page)";
    connectionEl.style.color = "#ff4444";
  };

  ws.onmessage = e => {
    const msg = JSON.parse(e.data);
    if (msg.type === "history") {
      msg.messages.forEach(addMessage);
    } else {
      addMessage(msg);
    }
  };
}
connect();

/* ===== CHAT RENDER ===== */
function addMessage(msg) {
  const d = document.createElement("div");
  d.className = "msg";

  if (msg.type === "image") {
    d.innerHTML = `<span class="name">${msg.name}:</span><br>
                   <img src="${msg.content}">`;
  }
  else if (msg.type === "audio") {
    d.innerHTML = `
      <span class="name">${msg.name}</span>
      just sent an audio<br>
      <button onclick='openAudio("${msg.content}")'>
        üîä Open in SoapySounds
      </button>`;
  }
  else {
    d.innerHTML = `<span class="name">${msg.name}:</span> ${msg.content}`;
  }

  chat.appendChild(d);
  chat.scrollTop = chat.scrollHeight;
}

/* ===== SEND TEXT ===== */
function send() {
  if (!joined) {
    ws.send(JSON.stringify({
      type: "join",
      name: nameInput.value || "Anonymous"
    }));
    nameInput.disabled = true;
    joined = true;
  }

  if (textInput.value.trim()) {
    ws.send(JSON.stringify({
      type: "message",
      content: textInput.value
    }));
    textInput.value = "";
  }
}

/* ===== IMAGE ===== */
function pickImage() { imgInput.click(); }

imgInput.onchange = () => {
  const r = new FileReader();
  r.onload = () => {
    ws.send(JSON.stringify({
      type: "image",
      content: r.result
    }));
  };
  r.readAsDataURL(imgInput.files[0]);
};

/* ===== SoapySounds ===== */
function openSoundWindow() {
  soundWindow.style.display = "flex";
}

function closeSoundWindow() {
  soundWindow.style.display = "none";
}

audioFile.onchange = () => {
  const r = new FileReader();
  r.onload = () => {
    currentAudio = r.result;
    audioPlayer.src = currentAudio;
  };
  r.readAsDataURL(audioFile.files[0]);
};

function sendAudio() {
  if (!currentAudio) return;

  ws.send(JSON.stringify({
    type: "audio",
    content: currentAudio
  }));

  closeSoundWindow();
}

function openAudio(data) {
  openSoundWindow();
  audioPlayer.src = data;
  audioPlayer.play();
}

/* ===== DRAG WINDOW ===== */
let drag = false, dx = 0, dy = 0;

soundTitle.onmousedown = e => {
  drag = true;
  dx = e.offsetX;
  dy = e.offsetY;
};

document.onmousemove = e => {
  if (!drag) return;
  soundWindow.style.left = (e.pageX - dx) + "px";
  soundWindow.style.top  = (e.pageY - dy) + "px";
};

document.onmouseup = () => drag = false;
</script>
</body>
</html>



