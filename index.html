<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Soapy Chat</title>
<style>
html,body{height:100%;margin:0;font-family:system-ui;background:radial-gradient(circle at top,#ff5ad6,#502070,#0b0314);color:white;}
#app{width:720px;height:85%;margin:40px auto;background:rgba(8,8,20,.92);border-radius:14px;display:flex;flex-direction:column;box-shadow:0 0 50px #ff5ad688;}
#chat{flex:1;padding:12px;overflow-y:auto;}
.msg{margin-bottom:10px;}
.name{color:#ff90ff;font-weight:bold;}
img{max-width:280px;border-radius:10px;margin-top:6px;box-shadow:0 0 15px #ff5ad655;}
audio{width:240px;}
.audio-bubble{margin-top:6px;padding:8px;border-radius:14px;background:#1a0f2a;box-shadow:inset 0 0 10px #000;}
.audio-bubble.voice{background:linear-gradient(135deg,#ff5ad6,#7a3cff);}
#controls{display:flex;gap:6px;padding:10px;align-items:center;}
#preview{padding:6px 10px;font-size:13px;color:#ffd1ff;}
#timer{font-size:13px;color:#ffd1ff;}
input,button{background:#1a0f2a;border:1px solid #ff5ad688;color:white;padding:8px;border-radius:8px;}
button{background:linear-gradient(135deg,#ff5ad6,#7a3cff);box-shadow:0 0 12px #ff5ad666;cursor:pointer;}
button.icon{width:40px;height:40px;padding:0;font-size:18px;}
</style>
</head>
<body>
<div id="app">
  <div id="chat"></div>
  <div id="preview"></div>
  <div id="controls">
    <button class="icon" onclick="pickImage()">üñºÔ∏è</button>
    <button class="icon" onclick="pickAudio()">üîä</button>
    <button class="icon" id="voiceBtn" onclick="recordVoice()">üé§</button>
    <span id="timer"></span>
    <input id="name" placeholder="Name">
    <input id="text" placeholder="Message">
    <input type="file" id="img" accept="image/*" hidden>
    <input type="file" id="aud" accept="audio/*" hidden>
    <button onclick="send()">Send</button>
  </div>
</div>

<script>
const ws = new WebSocket((location.protocol==="https:"?"wss://":"ws://")+location.host+"/ws");

let joined=false;
let userName="";
let pendingFile=null;
let pendingType=null;
let pendingVoice=false;

const chat=document.getElementById("chat");
const preview=document.getElementById("preview");
const timer=document.getElementById("timer");
const nameInput=document.getElementById("name");
const textInput=document.getElementById("text");
const voiceBtn=document.getElementById("voiceBtn");

ws.onmessage=e=>{
  const msg=JSON.parse(e.data);
  if(msg.type==="history") msg.messages.forEach(addMessage);
  else addMessage(msg);
};

function addMessage(msg){
  const d=document.createElement("div"); d.className="msg";
  if(msg.type==="image") d.innerHTML=`<span class="name">${msg.name}:</span><br><img src="${msg.content}">`;
  else if(msg.type==="audio") d.innerHTML=`<span class="name">${msg.name}:</span><div class="audio-bubble ${msg.voice?"voice":""}"><audio controls src="${msg.content}"></audio></div>`;
  else d.innerHTML=`<span class="name">${msg.name}:</span> ${msg.content}`;
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
}

// ===== JOIN & SEND =====
function send(){
  // join first
  if(!joined){
    userName=nameInput.value||"Anonymous";
    ws.send(JSON.stringify({type:"join",name:userName}));
    nameInput.disabled=true;
    joined=true;
  }

  // if a pending file exists
  if(pendingFile){
    const reader=new FileReader();
    reader.onload=()=>{
      ws.send(JSON.stringify({
        type:pendingType,
        content:reader.result,
        voice:pendingVoice
      }));
      // reset
      pendingFile=null; pendingType=null; pendingVoice=false;
      preview.textContent="";
    };
    reader.readAsDataURL(pendingFile);
    return;
  }

  // text messages
  if(textInput.value.trim()){
    ws.send(JSON.stringify({type:"message",content:textInput.value}));
    textInput.value="";
  }
}

// ===== FILE PICKERS =====
const img=document.getElementById("img");
const aud=document.getElementById("aud");

img.onchange=()=>{pendingFile=img.files[0]; pendingType="image"; pendingVoice=false; preview.textContent="üñºÔ∏è Image ready to send";};
aud.onchange=()=>{pendingFile=aud.files[0]; pendingType="audio"; pendingVoice=false; preview.textContent="üîä Audio file ready to send";};

function pickImage(){img.click();}
function pickAudio(){aud.click();}

// ===== VOICE RECORDING =====
let recording=false,seconds=0,timerInt;
async function recordVoice(){
  if(recording) return;
  recording=true; seconds=0;
  voiceBtn.textContent="‚¨ÜÔ∏è"; timer.textContent="0:00 / 1:00";

  const stream=await navigator.mediaDevices.getUserMedia({audio:true});
  const rec=new MediaRecorder(stream); const chunks=[];
  rec.ondataavailable=e=>chunks.push(e.data);

  rec.onstop=()=>{
    pendingFile=new Blob(chunks,{type:"audio/webm"});
    pendingType="audio"; pendingVoice=true;
    preview.textContent="üé§ Voice message ready to send";

    voiceBtn.textContent="üé§"; timer.textContent="";
    recording=false; clearInterval(timerInt);
    stream.getTracks().forEach(t=>t.stop());
  };

  rec.start();
  timerInt=setInterval(()=>{
    seconds++;
    timer.textContent=`0:${String(seconds).padStart(2,"0")} / 1:00`;
    if(seconds>=60) rec.stop();
  },1000);
}
</script>
</body>
</html>
